#!/usr/bin/env node

var
  program = require('commander'),
  util = require('util'),
  exec = require('child_process').exec,
  fs = require('fs'),
  start_home = process.env['HOME'] + '/.start',
  appStarted = false,
  apps,
  init, parseFiles, parseApp, startApp, debug,

  setUpStartDirectory, findAppFile, parseAppFile;

debug = function (message) {
  if (program.debug) {
    console.log(message);
  }
};

setUpStartDirectory = function () {
  console.log("Could not read .start directory");
  return;

  // if we can't find one, ask to set one up
};

init = function () {

  fs.readdir(start_home, function (err, files) {
    if (err) {
      setUpStartDirectory();
    }
    findAppFile(files);
  });
};


findAppFile = function (files) {
  var foundIt = false;
  files.forEach(function (file) {
    if (file === 'apps.json') {
      foundIt = true;
      parseAppFile(file);
    }
  });

  if (!foundIt) {
    console.log("Couldn't find apps.json");
    program.prompt("Would you like to create one now [y/n]: ", function (answer) {
      var a = answer.toLowerCase();
      if (a === 'y') {
        console.log('ok then.');
      } else if (a === 'n'){
        console.log('fine. be that way.');
      }
      process.stdin.destroy();
    });
  }
};


parseAppFile = function (file) {
  var
    appJson = JSON.parse(fs.readFileSync(start_home + '/apps.json')),
    realPath;

  appJson.directories.forEach(function (dir) {
    realPath = fs.realpathSync( dir );

    debug("real path   : " + realPath);
    debug("current dir : " + process.cwd());

    if (realPath === process.cwd()) {
      debug("starting app");
      startApp(appJson.start_command);
    }
  });
};


startApp = function (cmd) {
  var proc;
  debug("running : " + cmd);
  proc = exec(cmd);
  proc.stdout.setEncoding('utf8');
  proc.stdout.on('data', util.print);
  proc.stderr.on('data', util.print);
};


program
  .version('0.0.0')
  .option('-d, --debug', 'logs debug statements')
  .parse(process.argv);



init();



